From 5edf774eb848b4b5518761d77d7a538287feb485 Mon Sep 17 00:00:00 2001
From: Jedediah Smith <jedediah@silencegreys.com>
Date: Wed, 16 Mar 2016 21:24:15 -0400
Subject: [PATCH] Knockback API


diff --git a/src/main/java/org/bukkit/entity/Entity.java b/src/main/java/org/bukkit/entity/Entity.java
index fc0de12..6789c30 100644
--- a/src/main/java/org/bukkit/entity/Entity.java
+++ b/src/main/java/org/bukkit/entity/Entity.java
@@ -52,6 +52,48 @@ public interface Entity extends Metadatable, CommandSender, Physical {
     public Vector getVelocity();
 
     /**
+     * Apply an impulse to this entity, i.e. a relative change in velocity.
+     *
+     * The given vector is added to the current velocity, and the entity's new
+     * velocity is synced to players in visible range.
+     *
+     * If this entity is a player, the impulse is sent directly to them,
+     * and will be applied by their client at the moment they received it.
+     *
+     * Players always receive their own velocity changes as impulses, never as
+     * absolute values. This results in more accurate physics, from the player's
+     * perspective, particularly with high-latency connections.
+     */
+    void applyImpulse(Vector impulse);
+
+    /**
+     * Set the knockback reduction for this entity.
+     *
+     * Set this to 0 for standard knockback mechanics.
+     * Set this to 1 to disable all knockback effects.
+     * Values between 0 and 1 reduce knockback impulses proportionally.
+     */
+    void setKnockbackReduction(float n);
+
+    /**
+     * Get this entity's knockback reduction
+     *
+     * @see #setKnockbackReduction(float)
+     */
+    float getKnockbackReduction();
+
+    /**
+     * Get the velocity of this entity, preferring an inferred value, if there is one.
+     *
+     * For {@link Player}s, this velocity is partly derived from positions reported by
+     * the client. This can be much more accurate than the velocity stored on the
+     * server, which is not affected by player movement at all.
+     *
+     * For all other entities, this returns the same value as {@link #getVelocity()}.
+     */
+    Vector getPredictedVelocity();
+
+    /**
      * Returns true if the entity is supported by a block. This value is a
      * state updated by the server and is not recalculated unless the entity
      * moves.
diff --git a/src/main/java/org/bukkit/entity/Player.java b/src/main/java/org/bukkit/entity/Player.java
index 3fe5807..0bddf35 100644
--- a/src/main/java/org/bukkit/entity/Player.java
+++ b/src/main/java/org/bukkit/entity/Player.java
@@ -24,6 +24,7 @@ import org.bukkit.map.MapView;
 import org.bukkit.plugin.messaging.PluginMessageRecipient;
 import org.bukkit.scoreboard.Scoreboard;
 import org.bukkit.util.RayBlockIntersection;
+import org.bukkit.util.Vector;
 
 /**
  * Represents a player, connected or not
diff --git a/src/main/java/org/bukkit/event/player/PlayerKnockbackEvent.java b/src/main/java/org/bukkit/event/player/PlayerKnockbackEvent.java
new file mode 100644
index 0000000..138cbc5
--- /dev/null
+++ b/src/main/java/org/bukkit/event/player/PlayerKnockbackEvent.java
@@ -0,0 +1,26 @@
+package org.bukkit.event.player;
+
+import org.bukkit.entity.Entity;
+import org.bukkit.entity.Player;
+import org.bukkit.util.Vector;
+
+/**
+ * Called when a player is knocked back by an attack or injury.
+ */
+public class PlayerKnockbackEvent extends PlayerVelocityEvent {
+
+    private final Entity damager;
+
+    public PlayerKnockbackEvent(Player player, Entity damager, Vector velocity) {
+        super(player, velocity);
+        this.damager = damager;
+    }
+
+    /**
+     * The entity that is knocking the player back, or null if the knockback
+     * is not caused by an entity.
+     */
+    public Entity getDamager() {
+        return damager;
+    }
+}
diff --git a/src/main/java/org/bukkit/event/player/PlayerVelocityEvent.java b/src/main/java/org/bukkit/event/player/PlayerVelocityEvent.java
index 69d2fce..d41a90a 100644
--- a/src/main/java/org/bukkit/event/player/PlayerVelocityEvent.java
+++ b/src/main/java/org/bukkit/event/player/PlayerVelocityEvent.java
@@ -6,16 +6,16 @@ import org.bukkit.event.HandlerList;
 import org.bukkit.util.Vector;
 
 /**
- * Called when the velocity of a player changes.
+ * Called when an impulse is applied to a player.
  */
 public class PlayerVelocityEvent extends PlayerEvent implements Cancellable {
     private static final HandlerList handlers = new HandlerList();
     private boolean cancel = false;
-    private Vector velocity;
+    private Vector impulse;
 
-    public PlayerVelocityEvent(final Player player, final Vector velocity) {
+    public PlayerVelocityEvent(final Player player, final Vector impulse) {
         super(player);
-        this.velocity = velocity;
+        this.impulse = impulse;
     }
 
     public boolean isCancelled() {
@@ -27,21 +27,32 @@ public class PlayerVelocityEvent extends PlayerEvent implements Cancellable {
     }
 
     /**
-     * Gets the velocity vector that will be sent to the player
-     *
-     * @return Vector the player will get
+     * The absolute velocity of the player after applying the impulse
      */
     public Vector getVelocity() {
-        return velocity;
+        return getPlayer().getVelocity().add(impulse);
     }
 
     /**
-     * Sets the velocity vector that will be sent to the player
-     *
-     * @param velocity The velocity vector that will be sent to the player
+     * Change the impulse that will be applied to the player by specifying
+     * the player's desired absolute velocity after applying it.
      */
     public void setVelocity(Vector velocity) {
-        this.velocity = velocity;
+        this.impulse = velocity.clone().subtract(getPlayer().getVelocity());
+    }
+
+    /**
+     * The impulse that will be applied to the player
+     */
+    public Vector getImpulse() {
+        return impulse.clone();
+    }
+
+    /**
+     * Change the impulse that will be applied to the player
+     */
+    public void setImpulse(Vector impulse) {
+        this.impulse = impulse.clone();
     }
 
     @Override
-- 
1.9.0

